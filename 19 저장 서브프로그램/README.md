# 저장 서브프로그램 

## 저장 서브 프로그램이란?

- 앞서 다룬 PL/SQL 블록은 작성한 내용을 단 한 번 실행하는 데 사용했습니다. 이런 블록을 이름이 정해져 있지 않은 PL/SQL 블록이라는 의미로 익명 블록(anonymouse block)이라고 부릅니다. 익명 블록은 오라클에 저장되지 않기 때문에 한 번 실행한 뒤에 다시 실행하려면 PL/SQL 블록을 다시 작성하여 실행해야 합니다.
- 그런데 PL/SQL로 만든 프로그램을 주기적으로 또는 필요할 때마다 여러 번 사용할 목적으로 이름을 지정하여 오라클에 저장해 두는 PL/SQL 프로그램을 저장 서브프로그램(stored subprogram)이라고 합니다.
- 익명 블록과 달리 저장 서브프로그램은 오라클에 저장하여 공유할 수 있으므로 메모리,성능,재사용성 등 여러 면에서 장점이 있습니다. 


||익명 블록|저장 서브프로그램|
|----|-----|-----|
|이름|이름 없음|이름 지정|
|오라클 저장|저장할 수 없음|저장함|
|컴파일|실행할 때마다 컴파일|저장할 때 한 번 컴파일|
|공유|공유할 수 없음|공유하여 사용 가능|
|다른 응용 프로그램에서의 호출 가능 여부|호출할 수 없음|호출 가능|

- 오라클에서는 용도에 따라 여러 가지 방식으로 저장 프로그램을 구현할 수 있는데 대표적인 구현 방식은 프로시저,함수,패키지,트리거입니다. 

|서브프로그램|용도|
|----|-----|
|저장 프로시저<br>(stored procedure)|일반적으로 특정 처리 작업 수행을 위한 서브프로그램으로 SQL문에서는 사용할 수 없습니다.|
|저장 함수<br>(stored function)|일반적으로 특정 연산을 거친 결과 값을 반환하는 서브프로그램으로 SQL문에서 사용할 수 있습니다.|
|패키지<br>(package)|저장 서브프로그램을 그룹화하는 데 사용합니다.|
|트리거<br>(trigger)|특정 상황(이벤트)이 발생할 때 자동으로 연달아 수행할 기능을 구현하는 데 사용합니다.|

--- 
# 프로시저 

- 저장 프로시저(stored procedure)는 특정 처리 작업을 수행하는 데 사용하는 저장 서브프로그램으로 용도에 따라 파라미터를 사용할 수 있고 사용하지 않을 수도 있습니다.

## 파라미터를 사용하지 않는 프로시저
### 프로시저 생성하기
- 작업 수행에 별다른 입력 데이터가 필요하지 않을 경우에 파라미터를 사용하지 않는 프로시저를 사용합니다. 다음과 같이 CREATE [OR REPLACE] PROCEDURE를 사용해 만들 수 있습니다. 앞에서 다룬 익명 블록과 마찬가지로 프로시저도 선언부, 실행부, 예외 처리부로 이루어져 있습니다.

```
CREATE [OR REPLACE(1)] PROCEDURE 프로시저 이름(2) 
IS | AS - (3) 
    선언부 
BEGIN 
    실행부
EXCEPTION - (4) 
    예외 처리부
END [프로시저 이름]; - (5) 
```

|번호|설명|
|---|-----|
|(1)|지정한 프로시져 이름을 가진 프로시저가 이미 존재하는 경우에 현재 작성한 내용으로 대체합니다. 즉 덮어쓴다는 뜻이며 생략 가능한 옵션입니다.|
|(2)|저장할 프로시저의 고유 이름을 지정합니다. 같은 스키마 내에 중복될 수 없습니다.|
|(3)|선언부를 시작하기 위해 IS 또는 AS 키워드를 사용합니다. 선언부가 존재하지 않더라도 받드시 명시합니다. DECLARE 키워드는 사용하지 않습니다.|
|(4)|예외 처리부는 생략 가능합니다.|
|(5)|프로시저 생성의 종료를 뜻하며 프로시저 이름은 생략 가능합니다.|

- 프로시저 생성하기 

```sql
CREATE OR REPLACE PROCEDURE pro_noparam
IS 
	V_EMPNO NUMBER(4) := 7788;
	V_ENAME VARCHAR2(10);
BEGIN
	V_ENAME := 'SCOTT';
	DBMS_OUTPUT.PUT_LINE('V_EMPNO : ' || V_EMPNO);
	DBMS_OUTPUT.PUT_LINE('V_ENAME : ' || V_ENAME);
END;
/
```

#### SQL*PLUS로 프로시저 실행하기
- 생성한 프로시저는 SQL\*PLUS에서 바로 사용하거나 다른 PL/SQL 블록에서 실행할 수 있습니다. SQL\*PLUS에서 실행할 때 다음과 같이 EXECUTE 명령어를 사용합니다.

```
EXECUTE 프로시저 이름;
```

- 생성한 프로시저 실행하기

```sql
SET SERVEROUTPUT ON;
EXECUTE pro_noparam;
```

#### PL/SQL 블록에서 프로시저 실행하기
- 특정 PL/SQL 블록에서 이미 만들어져 있는 프로시저를 실행한다면 오른쪽과 같이 실행부에 실행할 프로시저 이름을 지정합니다.

```
BEGIN
    프로시저 이름;
END;
```

- 익명 블록에서 프로시저 실행하기

```sql
BEGIN
    pro_noparam;
END;
/
```
> 출력 결과가 나오지 않는다면 실행 전 SET SERVEROUTPUT ON 명령어의 실행을 확인해 주세요.


#### 프로시저 내용 확인하기

- 이미 저장되어 있는 프로시저를 포함하여 서브프로그램의 소스 코드 내용을 확인하려면 USER_SOURCE 데이터 사전에서 조회합니다.

|USER_SOURCE의 열|설명|
|---|----|
|NAME|서브프로그램(생성 객체) 이름|
|TYPE|서브프로그램 종류(PROCEDURE, FUNCTION 등)|
|LINE|서버프로그램에 작성한 줄 번호|
|TEXT|서브프로그램에 작성한 소스 코드|

- USER_SOURCE를 통해 프로시저 확인하기(Dbeaver)

```sql
SELECT * 
	FROM USER_SOURCE
WHERE NAME = 'PRO_NOPARAM';
```

- USER_SOURCE를 통해 프로시저 확인하기(SQL\*PLUS)<br>(SQL\*PLUS에서 사용한다면 TEXT열을 조회해 주면 됩니다.)

```sql
SELECT TEXT
	FROM USER_SOURCE
WHERE NAME = 'PRO_NOPARAM';
```

#### 프로시저 삭제하기
- DROP PROCEDURE 명령어로 프로시저를 삭제할 수 있습니다.

```sql
DROP PROCEDURE PRO_NOPARAM;
```

- 이미 저장되어 있는 프로시저의 소스 코드를 변경할 때는 <code>CREATE OR REPLACE PROCEDURE</code> 명령어로 프로시저를 재생성합니다. ALTER PROCEDURE는 프로시저의 소스 코드 내용을 재컴파일하는 명령어이므로 작성한 코드 내용을 변경하지 않습니다.

### 파라미터를 사용하는 프로시저 

- 프로시저를 실행하기 위해 입력 데이터가 필요한 경우에 파라미터를 정의할 수 있습니다. 파라미터는 여러 개 작성할 수 있으며 다음과 같은 형식으로 사용합니다.

```
CREATE [OR REPLACE(1)] PROCEDURE 프로시저 이름(2)
[(파라미터 이름1 [modes] 자료형 [ := | DEFAULT 기본값], - (3)
  파라미터 이름2 [modes] 자료형 [ := | DEFAULT 기본값],
  ...
  파라미터 이름N [modes] 자료형 [ := | DEFAULT 기본값]
)]
IS | AS - (4)
    선언부
BEGIN
    실행부
EXCEPTION - (5) 
    예외 처리부
END [프로시저 이름]; - (6)
```

|번호|설명|
|---|-----|
|(1)|지정한 프로시저 이름을 가진 프로시저가 이미 존재하는 경우에 현재 작성한 내용으로 대체합니다. 즉 덮어쓴다는 뜻이며 생략 가능한 옵션입니다.|
|(2)|저장할 프로시저의 고유 이름을 지정합니다. 같은 스키마 내에서 중복될 수 없습니다.|
|(3)|실행에 필요한 파라미터를 정의합니다. 파라미터는 쉼표(,)로 구분하여 여러 개 지정할 수 있습니다. 기본값과 모드(modes)는 생략 가능합니다. 자료형은 자릿수 지정 및 NOT NULL 제약 조건 사용이 불가능합니다.|
|(4)|선언부를 시작하기 위해 IS 또는 AS 키워드를 사용합니다. 선언부가 존재하지 않더라도 반드시 명시합니다. DECLARE 키워드는 사용하지 않습니다.|
|(5)|예외 처리부는 생략 가능합니다.|
|(6)|프로시저 생성의 종료를 뜻하며 프로시저 이름은 생략 가능합니다.|

- 파라미터를 지정할 때 사용하는 모드는 IN, OUT, IN OUT 세가지가 있습니다. 

|파라미터 모드|설명|
|----|-----|
|IN|지정하지 않으면 기본값으로 프로시저를 호출할 때 값을 입력받습니다.|
|OUT|호출할 때 값을 반환합니다.|
|IN OUT|호출할 때 값을 입력받은 후 실행 결과 값을 반환합니다.|

#### IN 모드 파라미터
- 프로시저 실행에 필요한 값을 직접 입력받는 형식의 파라미터를 지정할 때 IN을 사용합니다. 
- IN은 기본값이기 때문에 생략 가능합니다. 
- 프로시저에 파라미터 지정하기

```sql
CREATE OR REPLACE PROCEDURE pro_param_in 
(
	param1 IN NUMBER,
	param2 NUMBER,
	param3 NUMBER := 3,
	param4 NUMBER DEFAULT 4
)
IS 

BEGIN 
	DBMS_OUTPUT.PUT_LINE('param1 : ' || param1);
	DBMS_OUTPUT.PUT_LINE('param2 : ' || param2);
	DBMS_OUTPUT.PUT_LINE('param3 : ' || param3);
	DBMS_OUTPUT.PUT_LINE('param4 : ' || param4);
END;
/
```

- 파라미터를 입력하여 프로시저 사용하기

```
EXECUTE pro_param_in(1,2,9,8);
```

- 파라미터 param3, param4는 기본값이 지정되어 있는 상태이므로 호출할 때 값을 지정하지 않아도 실행이 가능합니다. 다음과 같이 두 개 값만 지정하여 프로시저를 실행하면 기본값이 지정된 param3, param4는 기본값이 출력되고 두 값은 param1, param2 파라미터에 순서대로 입력됩니다.

```
EXECUTE pro_param_in(1,2);
```

- param1, param2 파라미터는 기본값이 지정되어 있지 않습니다. 만약 pro_param_in 프로시저를 호출 할 때 기본값이 지정되지 않은 파라미터 수보다 적은 수의 값을 지정하면 프로시저 실행은 실패하게 됩니다.

```
EXECUTE pro_param_in(1);
```

- 결과 화면

```
*
1행에 오류:
ORA-06550: 줄 1, 열7:PLS-00306: 'PRO_PARAM_IN' 호출 시 인수의 갯수나 유형이
잘못되었습니다
ORA-06550: 줄 1, 열7:PL/SQL: Statement ignored
```

- 만약 위 예와는 달리 기본값이 지정된 파라미터와 지정되지 않은 파라미터의 순서가 섞여 있다면 기본값이 지정되지 않은 파라미터까지 값을 입력해 주어야 합니다. 즉 다음과 같이 파라미터가 지정되어 있다면 프로시저를 실행할 때 최소한 세 개 값을 입력해 주어야 합니다.

---
# 함수 

---
# 패키지 

---
# 트리거 